---
title: Распознавание текста на изображениях
date: 2019-04-30
minutes: 8
---

Как потомки героев войны могут отследить боевой путь своих предков?
В послевоенные годы в архивых страны накопилось множество документов
обо всех призывника, их назначениях, боевом пути, а также их судьбе.
Оцифровка этих документов - трудоемкий и долгий процесс, ускорить которой
вполне возможно за счет технологии распознавания текста (OCR).

### Как это работает

Как и многие другие задачи в компьютерном зрении распознавание текста в картинках
состоит из двух этапов:
1. Найти текст в изображении
2. Распознать символы, буквы и цифры, найденные на первом этапе

_Возьмем как пример такое изображение_

<img src="/assets/images/mars_boarding.png" alt="Посадочный талон - билет на Марс">

_Поиск текста на изображении_

<img src="/assets/images/text_detected.png" alt="Результат поиска текста">

С использованием открытого детектора текста нам удалось найти 55 текстовых областей.
Причем заметно, что горизонтальный текст обнаруживается лучше (более точные прямоугольники)
вне зависимости от размера и шрифта. Также отметим, насколько хорошо детектор видит
пробелы - слова на 1 строке попали в разные прямоугольники.

_Распознавание обнаруженного текста_

<img src="/assets/images/text_recognized.png" alt="Распознавание текста">

Как видим, в случаях когда текст ровный ("BOADRDING", "MARS", "2020"), четко видны буквы и цифры,
алгоритму [tesseract-ocr](https://github.com/tesseract-ocr/tesseract/wiki)
легко удается правильно определить весь текст. Хорошая точность достигается
за счет рекуррентных нейросетей, которые лучше всего справляются с последовательностью данных.
Однако когда появляется некий шум как в примерах ("STATION", "SCHEDULED") в результате добавляются ненужные символы.
На последних двух изображениях не удается определить легитимного текста вообще: пример того,
как ошибки первого этапа поиска текста влияют на распознавание текста.

### Адаптация OCR под свою задачу

Тогда как возможно использовать открытые алгоритмы, для достижения наивысшей точности
целесообразно обучить нейронные сети для работы с собственным
набором данных. Обучение алгоритмов также происходит в 2 этапа: детекция текста и распознавание.
При обучении потребуются размеченные данные в большом количестве, что может быть затратно
для небольших и средних компаний, поэтому возможно комбинировать собственный массив текстовых изображений с
открытыми наборами данных. Нередко для увеличения обучающей выборки данные синтезируются
самими разработчиками.

При обучении собственного алгоритма также учитывается целевое применение. Если алгоритм
должен работать на мобильных устройствах или в режиме реального времени, то выбираются легковесные
модели; если предполагается, что изображения содержат немного текста, то можно объединить детекцию
и распознавание в 1 модель для увеличения скорости обработки.

<img src="/assets/images/passport_text_recognition.png" alt="Распознавание текста на паспорте РФ">
<a href="https://habr.com/ru/company/smartengines/blog/252703/" style="font-size: 8px;">источник</a>


При обучении нейронных сетей под свою задачу можно достичь такого же результата, как на изображении выше.
Алгоритмы достаточно хорошо находят текст и оцифровывают его, причем распознается только целевой текст и
правильно классифицирует такие схожие сущности как имя и фамилия, серия и номер, и т.д.
Высокое качество достигается за счет обработки сразу нескольких последовательных кадров, что
позволяет снизить уровень шума.

### Рукописный текст

В разпознавании рукописного текста иная ситуация. На данный момент нет универсальных алгоритмов, которые могли бы применяться
для любого рукописного текста хотя бы на 1 языке. Данная проблема решается посегментно - в большинстве случаев
компании могут решать свои узкоспециализированные задачи за счет оцифровки рукописного текста.

_Оцифровка рукописного текста с помощью открытых алгоритмов_

<table><tr>
    <td><img src="/assets/images/handwriting_detection.png" alt="detect handwriting"></td>
    <td><img src="/assets/images/handwriting_recognition.png" alt="recognize handwriting"></td>
</tr></table>

Хотя и алгоритмы способны определить рукописный текст также как и машинный, полнота распознавания заметно ниже.
Однако судя по распознаванию найденного текста, мы видим, что даже легкие слова как (_"and"_, _"neat"_) распознаются неверно,
причем даже сама длина слова определяется неверно.
Единственный выход - обучать нейронные сети, заточенные под конкретный формат и топологию текста.

### Применение OCR

OCR - активно развивающаяся сфера, так как применений у данной технологий очень много.
Вот только некоторые из них:
* распознавание данных с документов, как персональных (паспорт, ИНН и т.д.) так и деловых (акты, счета, накладные и т.д.)
* оцифровка бумажных документов, архивов
* распознавание автомобильных номерных знаков
* [мгновенный фото-переводчик](https://translate.yandex.com/ocr)
* распозавание данных с банковской карты для быстрого перевода денег

В-общем, технология OCR может внедрятся в любой деятельности, в которой необходимо создать альтернативу ручному вводу данных,
чтобы снизить трудоемкость, процент ошибок или увеличить скорость обработки данных. Другая цель
развертывания OCR - сбор данных - например, нанесение адресов жилых домов на карты с данных уличной фотосъемки.

_Пример детекции и распознавания текста (Счет на оплату)_

<table><tr>
    <td><img src="/assets/images/invoice_detected.png" alt="detect invoice"></td>
    <td><img src="/assets/images/invoice_recognized.png" alt="recognize invoice"></td>
</tr></table>

Как видим на изображении слева детекция с помощью открытых алгоритмов показывает среднее качество:
прямоугольники хорошо покрывают текст на изображении, однако много пересечений между прямоугольниками.
На изображении справа (восстановленном после распознавания найденного текста) отчетливо понятно,
что такой алгоритм нельзя применить в промышленном масштабе, так как придется иметь дело с большим количеством неточностей.
К счастью, такие проблемы решаются достаточно легко с помощью обучения собственных нейросетевых алгоритмов.

### Сложности реализации

При реализации проектов в области распозанавания текста на картинках возникает немало сложностей.
Сложности возникают на разных стадиях и решаются совершенно разными методами.

- **Шум во входных данных**. Как и в любых других проектах, связанных с компьютерным зрением, на качество распознавания влияет
качество съемки: смазанность текста, блики на глянцевых документах или плохое освещение неминуемо
приведут к потерянным данным. Для борьбы с таким шумом необходимо мотивитировать самого пользователя
минимизировать низкокачественные фото на этапе съемки.
- **Топология текста**. Тогда как для человека не составляет труда
разделить слова пробелами или разбить параграф на разные строки, то для алгоритмов это дополнительная
сложность. Целесообразнее уже на этапе разметки данных понимать, каким образом будет применяться модель,
и создать аннотацию, которая будет отражать разные строки и слова при необходимости. Если это не было
учтено, то возможно, хотя это менее эффективно, применить классические методы
компьютерного зрения по отделению фона от полезной информации.
- **Очистка полученного текста**.
Как видно на примерах выше не всегда удается получить точный результат, поэтому выходные данные
от нейронных сетей можно и нужно дополнительно обрабатывать, чтобы устранить известные нам косяки.
Здесь чаще всего применяются методы обработки естесственного языка, такие как регулярные выражения,
заданные словари или распознавание именованных сущностей.

### Вместо заключения

В конце отметим, что для решения конкретной проблемы логично делать поступательные шаги
и с каждым новым шагом улучшать результаты. Например, для внедрения OCR можно последовательно
пройти несколько этапов:
1. Подготовить небольшие тестовые данные из собственных источников для валидации алгоритмов.
На основе этих данных мы будем визуально выбирать лучший алгоритм и определять точность.
2. Протестировать открытые алгоритмы на тестовом множестве из этапа 1.
**Цель** - понять потенциал применения OCR к этим данным.
3. Обучить нейронные сети на открытых данных наиболее приближенных к своим.
**Цель** - разработать первый прототип для развертывания и тестирования внутри.
4. Собрать собственный набор данных и разметить его. **Цель** - получить объемную обучающую и тестовую
выборки для дальнейшей количественной оценки новых алгоритмов.
5. Обучить нейронные сети (сверточные / сверточные + рекуррентные) на собственном наборе данных.
**Цель** - создать модели для промышленного применения с максимально возможной точностью и скоростью работы.
