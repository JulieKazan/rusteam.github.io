---
title: Как посчитать количество людей в магазине
date: 2019-07-25
minutes: 6
author: Rustem G
---

Тогда как количество посетителей сайтов или онлайн-магазинов и их конверсия измеряется достаточно просто, традиционные точки продаж не всегда могут эффективно оценить свою клиентскую базу, так как достаточно трудоемко посчитать всех людей, которые посещали магазин в течение дня, но не совершали покупки. В этой статей мы разберем, как можно построить систему по подсчету количества уникальных посетителей и других связанных метрик за счет анализа видеоряда с камер наблюдения.

## Традиционные методы

Возможно, все замечали, как при входе в торговый центр специальный человек, часто студент, отмечает посетителей на листочке. Стоит только догадываться, что происходит дальше: вероятнее всего листочки со всех входов сводятся в одну кучу и данные суммируются. У
такого решения сразу можно отметить несколько крупных недостатков:
- **невысокая точность** - не учитывается уникальность посетителей, например когда один и тот же человек прошел через несколько входов, а также не исключается человеческие ошибки при вводе данных;
- **не масштабируется** - для каждой новой точки входа нужен новый человек и растут расходы на оплату труда;
- **неполное** - нельзя измерить другие показатели, помимо количества людей. Каждый новый атрибут будет увеличивать трудоемкость в два раза.

Здесь мы расскажем о том, как мы решали проблему подсчета уникальных посетителей на торговой точке с использованием компьютерного зрения и алгоритмов глубокого обучения.

## Этапы разработки

#### Описание задачи

Для заказчика проекта было необходимо уметь считать сколько человек посещает точку продаж и сколько из них конвертируется в покупателей. Также с точки зрения аналитики продаж заказчик хотел понять в какое время дня и недели наивысшая загруженность, время обслуживания одного покупателя и демографический срез посетителей.

Таким образом мы декомпозировали весь проект на 4 задачи:
1. Найти лица на видео.
2. Распознавание лиц для измерения их схожести с друг другом.
3. Кластеризация лиц по схожести и подсчет кластеров, т.е. уникальных посетителей.
4. Аналитика: время посещений, длительность обслуживания, пол и возраст покупателей.

Дальше немного подробнее про каждый этап.

#### 1. Детекция лиц

Для начала необходимо найти все лица на видеопотоке. Для этого запускаем алгоритм детекции лиц, вырезаем лица и сохраняем все найденные лица для дальнейшей обработки. В результате получаем большое количество изображений, но мы не знаем, какие из этих изображений относятся к одним и тем же людям:

<img src="/assets/images/detected_faces.png" alt="face detection">

Для увеличения качества распознавания лиц на следующем шаге будет целесообразно отфильтровать изображения низкого качества, например:
- выбрать изображения определенной высоты и ширины, таким образом, мы только будем анализировать людей, которые находятся в интересующей нас зоне поиска. Нижние и верхние пороги вычисляем эмпирически;
- отсеить нефронтальные и перекрытые лица, так как алгоритм распознавания лиц точнее определяет схожесть, когда есть полное изображение лица;
- удалить размытые изображения, которые часто встречаются на потоках видео с камер без высокой четкости.

Вот так выглядят нефронтальные изображения лиц, которые мы вычисляем на основании расположения ключевых точек: нос, рот и глаза:

<img src="/assets/images/non_frontal_faces.png" alt="faces not frontal">


##### 2. Распознавание лиц

На данном этапе мы должны создать векторные преставления лиц с помощью моделей распознавания лиц, в точности как в задаче идентификации по лицу, для того чтобы мы могли сравнить схожесть лиц попарно, как на картинке ниже (лица одно и того же человека будут иметь низкие значения):

<img src="/assets/images/face_distances.png" alt="face distances">

В некоторых случаях необходимо обучить алгоритм распознавания лиц так, чтобы качество изображений совпадало с качеством изображений в используемой камере. Это необходимо, так как если обучать алгоритм распознавания на фотографиях с высокой четкостью, то модели будут совершать множество ошибок на маленьких изображениях с видеоряда.

##### 3. Кластеризация лиц

Теперь обучаем несколько алгоритмов кластеризации на полученных векторах с предыдущего шага и выбираем наиболее подходящий в зависимости от ограничений по вычислительным ресурсам, времени на обработку и точности.

Подбираем методы, которые сами умеют определять количество кластеров, так как мы не можем знать заранее, сколько человек собираются посетить нашу торговую точку. Помимо самой кластеризации, проводим дополнительную пост-обработку: объединяем близкие кластеры и
разделяем кластеры с низким значением внутренней схожести.

<img src="/assets/images/face_clusters.jpg" alt="face clusters">

Соответственно, финальное количество кластеров будет равняться количеству уникальных посетителей, а в каждом кластере будут представлены лица одного и того же человека.

#### 4. Дополнительная аналитика

Сгруппировав изображения людей в кластеры, рассчитать время и длительность посещений не составит большого труда.

Для проведения демографического анализа потребуется обучение дополнительных алгоритмов распознавания пола и возраста. Далее мы применим эти алгоритмы для каждого кластера лиц и выберем наиболее частое значения для максимизации точности.

| Распознавание возраста в группы 15-20, 25-35 или 40-50 лет   | Определение пола (m - мужской, f - женский )    |
| :------------- | :------------- |
| <img src="/assets/images/age_classification.jpg" alt="age classes" style="margin-right: 10px">   | <img src="/assets/images/gender_detection.jpg" alt="gender classes" style="margin-left: 10px">     |

## Результаты

Добиться очень высоких результатов достаточно сложно, так как качество видеосъемки ниже, чем на фотографиях. Однако представленный подход способен решить задачу на приемлемом уровне для использования в системах, которые не требует медицинской точности или в качестве пред-обработки данных для визуальной верификации человеком. Другим важным уроком для нас стало то, что при работе с потоком видео критическую роль играет подготовка данных для моделей: чем меньше мусора мы подавали на вход, тем меньше мусора получали на выходе.
