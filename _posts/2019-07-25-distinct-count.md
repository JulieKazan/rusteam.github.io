---
title: Как посчитать количество людей в магазине
date: 2019-07-25
minutes: 6
---

Конверсия посетителей магазина в покупателей остается одной из
наиболее важных метрик для любого традиционного бизнеса. 
Тогда как количество покупок доступно на любом кассовом аппарате или
в CRM-системе, то количество покупателей требует более сложных 
технологических приемов.

Традиционно можно посадить студента, чтобы тот отмечал всех клиентов
на листочке или просматривал записи видеокамер, а потом посчитать количество
отметок. Такое решение конечно же быстрее, однако у него множество минусов,
среди которых:
- **не масштабируемо** - для каждой новой точки нужно искать нового человека и платить ему зарплату
- **ненадежное** - отметки на листочке подвержены человеческим ошибкам, а проверить расчеты достаточно трудозатратно<
- **неполное** - нельзя измерить другие показатели, помимо количества людей. Каждый новый атрибут будет увеличивать трудоемкость в два раза

Дальше в статье можно узнать, как построить систему с автоматическим
подсчетом уникальных посетителей с помощью анализа видео и применения
алгоритмов машинного обучения.

## Этапы разработки

После того, как поставлена задача и появились первые образцы видео,
можно приступить к исследованию и разработке решения.

##### Детекция лиц

На потоке видео запустить алгоритм детекции лиц и сохранятьвсе найденные лица для дальнейшей обработки. Также полезно будет
провести фильтрацию найденных лиц на данном этапе, чтобы уменьшить
объемы данных:
- Убрать слишком большие и слишком маленькие лица, таким образом,
мы избавимся от людей, которые не находятся в интересующей нас зоне поиска.
Нижние и верхние пороги вычисляем эмпирически.
- Полезно использовать алгоритм детекции, который также определяет
ключевые точки лица (глаза, нос и рот), и отсеить нефронтальные лица.
Данный шаг поможет избежать ошибок на следующем этапе.
- Другие типы очистки данных также могут улучшить точность расчетов,
например удаление размытых изображений, которые встречаются часто
при анализе видеорядов.

##### Распознавание лиц

Создать векторые преставления лиц с помощью пред-обученных
моделей распознавания лиц, в точности как в задаче идентификации по лицу.

В некоторых случаях необходимо обучить свой алгоритм распознавания лиц,
потому что качество детекций лиц на видеосъемке отличается от качества
изображений, которые используются в открытых моделях.

##### Кластеризация лиц

Теперь уже можно обучить несколько алгоритмов кластеризации на
полученных векторах и выбрать наиболее подходящий в зависимости от
ограничей по вычислительным ресурсам, времени на обработку и точности.

Вероятнее всего, придется отобрать методы, которые сами умеют определять
количество кластеров, так как мы не можем знать заранее, сколько человек
собираются посетить нашу торговую точку. Помимо самой кластеризации,
проводим дополнительную пост-обработку: объединяем близкие кластеры и
разделяем кластеры с низким значением внутренней схожести.

Соответственно, финальное количество кластеров будет равняться
количеству уникальных посетителей, а в каждом кластере будут
представлены лица одного и того же человека.

## Дополнительная аналитика

В дополнение к расчету количества посетителей, можно добавить более
глубокие формы анализа, такие как:
* Среднее время посещения магазина
* Пол и возраст покупателей
* Положительные и отрицательные эмоции
